The core computation of the algorithm
